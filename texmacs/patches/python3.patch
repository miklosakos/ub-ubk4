From 6547d2fe4e9f4c3c95f3482ed76f1c030c99ce98 Mon Sep 17 00:00:00 2001
From: Darcy Shen <sadhen@zoho.com>
Date: Sat, 14 Mar 2020 06:23:01 +0000
Subject: [PATCH] Use python3 for Python and Graph plugins

---
 plugins/asymptote/progs/init-asymptote.scm | 12 ++++++++--
 plugins/dratex/progs/init-dratex.scm       | 16 +++++++++----
 plugins/gnuplot/progs/init-gnuplot.scm     | 17 +++++++++----
 plugins/graph/progs/init-graph.scm         | 13 +++++++---
 plugins/graphviz/progs/init-graphviz.scm   | 10 ++++----
 plugins/python/progs/init-python.scm       | 28 ++++++++++++++--------
 plugins/xypic/progs/init-xypic.scm         | 12 ++++++++--
 7 files changed, 76 insertions(+), 32 deletions(-)

diff --git a/plugins/asymptote/progs/init-asymptote.scm b/plugins/asymptote/progs/init-asymptote.scm
index 1afb39bd5..cdb43f85a 100644
--- a/plugins/asymptote/progs/init-asymptote.scm
+++ b/plugins/asymptote/progs/init-asymptote.scm
@@ -11,6 +11,13 @@
 ;;
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
+(define (python-command)
+  (if (url-exists-in-path? "python3") "python3" "python2"))
+
+(define (python-exists?)
+  (or (url-exists-in-path? "python3")
+      (url-exists-in-path? "python2")))
+
 (define (asy-serialize lan t)
     (with u (pre-serialize lan t)
       (with s (texmacs->code (stree->tree u) "SourceCode")
@@ -18,15 +25,16 @@
 
 (define (asy-launcher)
   (if (url-exists? "$TEXMACS_HOME_PATH/plugins/tmpy")
-      (string-append "python \""
+      (string-append (python-command) " \""
                      (getenv "TEXMACS_HOME_PATH")
                      "/plugins/tmpy/session/tm_asy.py\"")
-      (string-append "python \""
+      (string-append (python-command) " \""
                      (getenv "TEXMACS_PATH")
                      "/plugins/tmpy/session/tm_asy.py\"")))
 
 (plugin-configure asymptote
   (:require (url-exists-in-path? "asy"))
+  (:require (python-exists?))
   (:launch ,(asy-launcher))
   (:serializer ,asy-serialize)
   (:session "Asymptote")
diff --git a/plugins/dratex/progs/init-dratex.scm b/plugins/dratex/progs/init-dratex.scm
index 4aab76365..1f02aff8e 100644
--- a/plugins/dratex/progs/init-dratex.scm
+++ b/plugins/dratex/progs/init-dratex.scm
@@ -3,8 +3,8 @@
 ;;
 ;; MODULE      : init-dratex.scm
 ;; DESCRIPTION : Initialize DraTex plugin
-;; COPYRIGHT   : (C) 2005 Nicolas Ratier
-;;               (C) 2019 Darcy Shen
+;; COPYRIGHT   : (C) 2005       Nicolas Ratier
+;;               (C) 2019-2020  Darcy Shen
 ;;
 ;; This software falls under the GNU general public license version 3 or later.
 ;; It comes WITHOUT ANY WARRANTY WHATSOEVER. For details, see the file LICENSE
@@ -12,6 +12,13 @@
 ;;
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
+(define (python-command)
+  (if (url-exists-in-path? "python3") "python3" "python2"))
+
+(define (python-exists?)
+  (or (url-exists-in-path? "python3")
+      (url-exists-in-path? "python2")))
+
 (define (dratex-serialize lan t)
     (with u (pre-serialize lan t)
       (with s (texmacs->code (stree->tree u) "SourceCode")
@@ -19,14 +26,15 @@
 
 (define (dratex-launcher)
   (if (url-exists? "$TEXMACS_HOME_PATH/plugins/tmpy")
-      (string-append "python \""
+      (string-append (python-command) " \""
                      (getenv "TEXMACS_HOME_PATH")
                      "/plugins/tmpy/session/tm_dratex.py\"")
-      (string-append "python \""
+      (string-append (python-command) " \""
                      (getenv "TEXMACS_PATH")
                      "/plugins/tmpy/session/tm_dratex.py\"")))
 
 (plugin-configure dratex
+  (:require (python-exists?))
   (:require (url-exists-in-path? "latex"))
   (:launch ,(dratex-launcher))
   (:serializer ,dratex-serialize)
diff --git a/plugins/gnuplot/progs/init-gnuplot.scm b/plugins/gnuplot/progs/init-gnuplot.scm
index 625378c70..319374d74 100644
--- a/plugins/gnuplot/progs/init-gnuplot.scm
+++ b/plugins/gnuplot/progs/init-gnuplot.scm
@@ -3,8 +3,8 @@
 ;;
 ;; MODULE      : init-gnuplot.scm
 ;; DESCRIPTION : Initialize GNUplot plugin
-;; COPYRIGHT   : (C) 1999  Joris van der Hoeven
-;;                   2019  Darcy Shen
+;; COPYRIGHT   : (C) 1999       Joris van der Hoeven
+;;                   2019-2020  Darcy Shen
 ;;
 ;; This software falls under the GNU general public license version 3 or later.
 ;; It comes WITHOUT ANY WARRANTY WHATSOEVER. For details, see the file LICENSE
@@ -12,6 +12,13 @@
 ;;
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
+(define (python-command)
+  (if (url-exists-in-path? "python3") "python3" "python2"))
+
+(define (python-exists?)
+  (or (url-exists-in-path? "python3")
+      (url-exists-in-path? "python2")))
+
 (define (gnuplot-serialize lan t)
     (with u (pre-serialize lan t)
       (with s (texmacs->code (stree->tree u) "SourceCode")
@@ -19,17 +26,17 @@
 
 (define (gnuplot-launcher)
   (if (url-exists? "$TEXMACS_HOME_PATH/plugins/tmpy")
-      `((:launch ,(string-append "python \""
+      `((:launch ,(string-append (python-command) " \""
                                  (getenv "TEXMACS_HOME_PATH")
                                  "/plugins/tmpy/session/tm_gnuplot.py\"")))
-      `((:launch ,(string-append "python \""
+      `((:launch ,(string-append (python-command) " \""
                                  (getenv "TEXMACS_PATH")
                                  "/plugins/tmpy/session/tm_gnuplot.py\"")))))
 
 
 (plugin-configure gnuplot
   (:require (url-exists-in-path? "gnuplot"))
-  (:require (url-exists-in-path? "python"))
+  (:require (python-exists))
   ,@(gnuplot-launcher)
   (:serializer ,gnuplot-serialize)
   (:session "Gnuplot")
diff --git a/plugins/graph/progs/init-graph.scm b/plugins/graph/progs/init-graph.scm
index 5c80fefa4..a4e7a5aa5 100644
--- a/plugins/graph/progs/init-graph.scm
+++ b/plugins/graph/progs/init-graph.scm
@@ -15,17 +15,24 @@
       (with s (texmacs->code (stree->tree u) "SourceCode")
         (string-append  s  "\n<EOF>\n"))))
 
+(define (python-command)
+  (if (url-exists-in-path? "python3") "python3" "python2"))
+
+(define (python-exists?)
+  (or (url-exists-in-path? "python3")
+      (url-exists-in-path? "python2")))
+
 (define (graph-launcher)
   (if (url-exists? "$TEXMACS_HOME_PATH/plugins/tmpy")
-      (string-append "python \""
+      (string-append (python-command) " \""
                      (getenv "TEXMACS_HOME_PATH")
                      "/plugins/tmpy/session/tm_graph.py\"")
-      (string-append "python \""
+      (string-append (python-command) " \""
                      (getenv "TEXMACS_PATH")
                      "/plugins/tmpy/session/tm_graph.py\"")))
 
 (plugin-configure graph
-  (:require (url-exists-in-path? "python"))
+  (:require (python-exists?))
   (:launch ,(graph-launcher))
   (:serializer ,graph-serialize)
   (:session "Graph"))
diff --git a/plugins/graphviz/progs/init-graphviz.scm b/plugins/graphviz/progs/init-graphviz.scm
index 59210bb97..3009d58da 100644
--- a/plugins/graphviz/progs/init-graphviz.scm
+++ b/plugins/graphviz/progs/init-graphviz.scm
@@ -16,10 +16,8 @@
       (with s (texmacs->code (stree->tree u) "SourceCode")
         (string-append s "\n<EOF>\n"))))
 
-(define (python-launcher)
-  (if (url-exists-in-path? "python3")
-      "python3"
-      "python2"))
+(define (python-command)
+  (if (url-exists-in-path? "python3") "python3" "python2"))
 
 (define (python-exists?)
   (or (url-exists-in-path? "python3")
@@ -27,11 +25,11 @@
 
 (define (graphviz-launcher)
   (if (url-exists? "$TEXMACS_HOME_PATH/plugins/tmpy")
-      (string-append (python-launcher)
+      (string-append (python-command)
                      " \""
                      (getenv "TEXMACS_HOME_PATH")
                      "/plugins/tmpy/session/tm_graphviz.py\"")
-      (string-append (python-launcher)
+      (string-append (python-command)
                      " \""
                      (getenv "TEXMACS_PATH")
                      "/plugins/tmpy/session/tm_graphviz.py\"")))
diff --git a/plugins/python/progs/init-python.scm b/plugins/python/progs/init-python.scm
index ebd56a04b..d9593ebf7 100644
--- a/plugins/python/progs/init-python.scm
+++ b/plugins/python/progs/init-python.scm
@@ -5,6 +5,7 @@
 ;; DESCRIPTION : Initialize python plugin
 ;; COPYRIGHT   : (C) 2004  Ero Carrera,
 ;;               (C) 2012  Adrian Soto
+;;               (C) 2020  Darcy Shen
 ;;
 ;; This software falls under the GNU general public license version 3 or later.
 ;; It comes WITHOUT ANY WARRANTY WHATSOEVER. For details, see the file LICENSE
@@ -18,30 +19,37 @@
 ;; Plugin configuration
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
-;;Basically, the serializer makes the input preserve the newlines
-;;and adds the string character "\n<EOF>\n" by the end.
-;;I guess it could send "\x04" instead to signal a real EOF,
-;;but I would need to check if that does not kill the pipe...
-;;An alternative approach is to use the input-done? command
-;;from TeXmacs, but, at the time of this writing, it did not work.--A
+;; Basically, the serializer makes the input preserve the newlines
+;; and adds the string character "\n<EOF>\n" by the end.
+;; I guess it could send "\x04" instead to signal a real EOF,
+;; but I would need to check if that does not kill the pipe...
+;; An alternative approach is to use the input-done? command
+;; from TeXmacs, but, at the time of this writing, it did not work.--A
 
 (define (python-serialize lan t)
   (with u (pre-serialize lan t)
     (with s (texmacs->code (stree->tree u) "SourceCode")
       (string-append  s  "\n<EOF>\n"))))
 
+(define (python-command)
+  (if (url-exists-in-path? "python3") "python3" "python2"))
+
+(define (python-exists?)
+  (or (url-exists-in-path? "python3")
+      (url-exists-in-path? "python2")))
+
 (define (python-launcher)
   (if (url-exists? "$TEXMACS_HOME_PATH/plugins/tmpy")
-      (string-append "python \""
+      (string-append (python-command) " \""
                      (getenv "TEXMACS_HOME_PATH")
                      "/plugins/tmpy/session/tm_python.py\"")
-      (string-append "python \""
+      (string-append (python-command) " \""
                      (getenv "TEXMACS_PATH")
                      "/plugins/tmpy/session/tm_python.py\"")))
 
 (plugin-configure python
-  (:winpath "Python2*" ".")
-  (:require (url-exists-in-path? "python"))
+  (:winpath "Python*" ".")
+  (:require (python-exists?))
   (:launch ,(python-launcher))
   (:tab-completion #t)
   (:serializer ,python-serialize)
diff --git a/plugins/xypic/progs/init-xypic.scm b/plugins/xypic/progs/init-xypic.scm
index 964a6b7cc..532bb6222 100644
--- a/plugins/xypic/progs/init-xypic.scm
+++ b/plugins/xypic/progs/init-xypic.scm
@@ -11,6 +11,13 @@
 ;;
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
+(define (python-command)
+  (if (url-exists-in-path? "python3") "python3" "python2"))
+
+(define (python-exists?)
+  (or (url-exists-in-path? "python3")
+      (url-exists-in-path? "python2")))
+
 (define (xypic-serialize lan t)
     (with u (pre-serialize lan t)
       (with s (texmacs->code (stree->tree u) "SourceCode")
@@ -25,14 +32,15 @@
                      (getenv "TEXMACS_PATH")
                      "/plugins/tmpy/session/tm_xypic.py\"")))
 
-(define (xypic-present?)
+(define (xypic-exists?)
   (and (url-exists-in-path? "latex")
        (cond ((url-exists-in-path? "kpsewhich")
               (!= (eval-system "kpsewhich xy.sty") ""))
              (else #f))))
 
 (plugin-configure xypic
-  (:require (xypic-present?))
+  (:require (python-exists?))
+  (:require (xypic-exists?))
   (:launch ,(xypic-launcher))
   (:serializer ,xypic-serialize)
   (:session "XYpic"))
